<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main">
  <button id="authorize_button" class="btn" onclick="handleAuthClick()">Authorize</button>
  <button id="signout_button" class="btn" onclick="handleSignoutClick()">Sign Out</button>
  <select id="sheetSelect"></select>
  <button id="submitBtn" class="btn" onclick="submit()">Submit</button>
  <h2 id="content"></h2>
</div>
    
<script type="text/javascript">
  const CLIENT_ID = "895893914279-cmijlnglcf8vud5ua7f4t0mme66gtov1.apps.googleusercontent.com";
  const API_KEY = "AIzaSyBT7l3GpLAY1hnCPZWahc3JKfMX6tcgiEI";
  const APP_ID = "895893914279";

  const SCOPES = "https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/spreadsheets.readonly";

  let tokenClient;
  let accessToken = null;
  let pickerInited = false;
  let gisInited = false;


  document.getElementById('authorize_button').style.visibility = 'hidden';
  document.getElementById('signout_button').style.visibility = 'hidden';

  /**
   * Callback after api.js is loaded.
   */
  function gapiLoaded() {
    gapi.load('client:picker', initializePicker);
  }

  /**
   * Callback after the API client is loaded. Loads the
   * discovery doc to initialize the API.
   */
  async function initializePicker() {
    await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
    await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
    pickerInited = true;
    maybeEnableButtons();
  }

  /**
   * Callback after Google Identity Services are loaded.
   */
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', // defined later
    });
    gisInited = true;
    maybeEnableButtons();
  }

  /**
   * Enables user interaction after all libraries are loaded.
   */
  function maybeEnableButtons() {
    if (pickerInited && gisInited) {
      document.getElementById('authorize_button').style.visibility = 'visible';
    }
  }

  /**
   *  Sign in the user upon button click.
   */
  function handleAuthClick() {
    tokenClient.callback = async (response) => {
      if (response.error !== undefined) {
        throw (response);
      }
      accessToken = response.access_token;
      document.getElementById('signout_button').style.visibility = 'visible';
      document.getElementById('authorize_button').innerText = 'Refresh';
      await createPicker();
    };

    if (accessToken === null) {
      // Prompt the user to select a Google Account and ask for consent to share their data
      // when establishing a new session.
      tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
      // Skip display of account chooser and consent dialog for an existing session.
      tokenClient.requestAccessToken({prompt: ''});
    }
  }

  /**
   *  Sign out the user upon button click.
   */
  function handleSignoutClick() {
    if (accessToken) {
      accessToken = null;
      google.accounts.oauth2.revoke(accessToken);
      document.getElementById('content').innerText = '';
      document.getElementById('authorize_button').innerText = 'Authorize';
      document.getElementById('signout_button').style.visibility = 'hidden';
    }
  }

  /**
   *  Create and render a Picker object for searching images.
   */
  function createPicker() {
    const view = new google.picker.View(google.picker.ViewId.DOCS);
    const picker = new google.picker.PickerBuilder()
      .enableFeature(google.picker.Feature.NAV_HIDDEN)
      .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
      .setDeveloperKey(API_KEY)
      .setAppId(APP_ID)
      .setOAuthToken(accessToken)
      .addView(view)
      .addView(new google.picker.DocsUploadView())
      .setCallback(pickerCallback)
      .build();
    picker.setVisible(true);
  }   

  /**
   * Displays the file details of the user's selection.
   * @param {object} data - Containers the user selection from the picker
   */
  async function pickerCallback(data) {
    if (data.action === google.picker.Action.PICKED) {
      let text = `Picker response: \n${JSON.stringify(data, null, 2)}\n`;
      // for (const document of data[google.picker.Response.DOCUMENTS]) {
      //   const fileId = document[google.picker.Document.ID];
      //   console.log(fileId);
      //   const res = await gapi.client.drive.files.get({
      //     'fileId': fileId,
      //     'fields': '*',
      //   });
      //   text += `Drive API response for document (ID: ${fileId}): \n${JSON.stringify(res.result, null, 2)}\n`;
      // }
      const selectedFiles = data[google.picker.Response.DOCUMENTS];
          if (selectedFiles.length > 0) {
            const fileId = selectedFiles[0][google.picker.Document.ID];
            await fetchSheetList(fileId);
            //await fetchSheetData(fileId);
          }
      // window.document.getElementById('content').innerText = text;
    }
  }

  async function fetchSheetData(fileId, title) {
    let response;
    try {
    // Fetch first 10 files
        response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: fileId,
            range: title,
    });
    } catch (err) {
        document.getElementById('content').innerText = err.message;
        return;
    }
    const range = response.result;
    if (!range || !range.values || range.values.length == 0) {
        document.getElementById('content').innerText = 'No values found.';
        return;
    }
    console.log(response.result.values);

    try {
      const backendResponse = await fetch('http://localhost:3000/api/saveSheetData', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ data: response.result.values }),
      });

      const result = await backendResponse.text();
      document.getElementById('content').innerText = result;
    } catch (error) {
      document.getElementById('content').innerText = 'Error saving data';
    }
  }

  async function fetchSheetList(fileId) {
    let response;
    try {
        // Lấy metadata của bảng tính
        response = await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: fileId,
        });
    } catch (err) {
        document.getElementById('content').innerText = err.message;
        return;
    }

    const sheets = response.result.sheets;
    if (!sheets || sheets.length == 0) {
        document.getElementById('content').innerText = 'Không tìm thấy sheet nào.';
        return;
    }

    // In danh sách các sheet ra console
    // sheets.forEach(sheet => {
    //     console.log(sheet.properties.title);
    // });

    const selectBox = document.getElementById('sheetSelect');
    selectBox.innerHTML = ''; // Clear any existing options
    // Thêm các sheet vào select box
    sheets.forEach(sheet => {
        const option = document.createElement('option');
        option.value = fileId;
        option.text = sheet.properties.title;
        selectBox.appendChild(option);
    });

    // document.getElementById('submitBtn').addEventListener('click', () => {
    //   const selectBox = document.getElementById('sheetSelect');
    //   const selectedOption = selectBox.options[selectBox.selectedIndex];
    //   const sheetId = selectedOption.value;
    //   const title = selectedOption.text;
    //   console.log(`Selected Sheet ID: ${sheetId}`);
    //   console.log(`Selected Sheet Title: ${title}`);
    // });
}

  async function submit() {
    const selectBox = document.getElementById('sheetSelect');
    const selectedOption = selectBox.options[selectBox.selectedIndex];
    const sheetId = selectedOption.value;
    const title = selectedOption.text;
    console.log(`Selected Sheet ID: ${sheetId}`);
    console.log(`Selected Sheet Title: ${title}`);
    await fetchSheetData(sheetId, title);
  }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

